<!-- ==================== 모바일 플로팅 채팅 버튼 + 미리보기 ==================== -->
<div class="lg:hidden fixed bottom-6 right-6 z-50 flex items-end gap-3" x-show="joined && !mobileChatOpen" x-cloak>
  <!-- 메시지 미리보기 -->
  <div x-show="previewMessage" x-cloak
    @click="hidePreviewAndOpenChat()"
    class="max-w-[200px] bg-gray-800 rounded-xl px-3 py-2 shadow-lg cursor-pointer border border-gray-700"
    x-transition:enter="transition ease-out duration-150"
    x-transition:enter-start="opacity-0 translate-x-2"
    x-transition:enter-end="opacity-100 translate-x-0"
    x-transition:leave="transition ease-in duration-100"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0">
    <p class="text-xs text-primary font-medium truncate" x-text="previewMessage?.nickname"></p>
    <p class="text-sm text-white truncate" x-text="previewMessage?.message"></p>
  </div>

  <!-- 플로팅 버튼 -->
  <button @click="openMobileChat()"
    class="w-14 h-14 bg-primary hover:bg-primary/80 rounded-full shadow-lg flex items-center justify-center relative transition-transform active:scale-95 flex-shrink-0"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 scale-90"
    x-transition:enter-end="opacity-100 scale-100">
    <i data-lucide="message-circle" class="w-6 h-6"></i>
    <!-- 새 메시지 알림 점 -->
    <span x-show="unreadCount > 0"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="scale-0"
      x-transition:enter-end="scale-100"
      class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs font-bold">
      <span x-text="unreadCount > 9 ? '9+' : unreadCount"></span>
    </span>
  </button>
</div>

<!-- ==================== 모바일 채팅 오버레이 ==================== -->
<div x-show="mobileChatOpen" x-cloak class="lg:hidden fixed inset-0 z-50">

  <!-- 배경 딤 -->
  <div @click="closeMobileChat()"
    class="absolute inset-0 bg-black/50 mobile-chat-backdrop"
    :class="{ 'open': mobileChatOpen && !mobileChatClosing }"></div>

  <!-- 채팅창 (하단 60%) -->
  <div class="absolute bottom-0 left-0 right-0 h-[60vh] bg-gray-800 rounded-t-2xl flex flex-col mobile-chat-panel"
    :class="{ 'open': mobileChatOpen && !mobileChatClosing, 'closing': mobileChatClosing }">

    <!-- 드래그 핸들 (스와이프 영역) -->
    <div class="flex justify-center py-3 flex-shrink-0 cursor-grab active:cursor-grabbing"
      @touchstart="handleSwipeStart($event)"
      @touchend="handleSwipeEnd($event)">
      <div class="w-12 h-1.5 bg-gray-600 rounded-full"></div>
    </div>

    <!-- 헤더 -->
    <div class="flex justify-between items-center px-4 pb-2 flex-shrink-0">
      <h3 class="font-semibold flex items-center gap-2 text-sm">
        <i data-lucide="message-square" class="w-4 h-4"></i> 채팅
      </h3>
      <button @click="closeMobileChat()" class="p-1 hover:bg-gray-700 rounded-lg transition-colors">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>

    <!-- 메시지 목록 -->
    <div class="flex-1 overflow-y-auto px-4 space-y-2 min-h-0" x-ref="mobileChatContainerRef">
      <%- include('chat-messages') %>
    </div>

    <!-- 입력 폼 -->
    <div class="p-4 flex-shrink-0 pb-safe">
      <form @submit.prevent="sendChat()" class="flex gap-2"
        x-show="room.state !== 'defense' || defenderId === playerId">
        <input
          type="text"
          x-model="chatInput"
          placeholder="메시지"
          maxlength="200"
          class="flex-1 min-w-0 px-3 py-2 bg-gray-700 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none"
        >
        <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg text-sm transition-colors">전송</button>
      </form>
      <div x-show="room.state === 'defense' && defenderId !== playerId" class="text-gray-500 text-xs text-center">
        변론자만 채팅할 수 있습니다
      </div>
    </div>
  </div>
</div>
