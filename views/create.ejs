<!DOCTYPE html>
<html lang="ko">
<head>
  <%- include('partials/head') %>
</head>
<body class="bg-gray-900 text-white min-h-screen">
<div class="container mx-auto px-4 py-8 max-w-lg">
  <a href="/" class="inline-flex items-center gap-2 text-gray-400 hover:text-white mb-8 transition-colors">
    <- 로비로 돌아가기
  </a>

  <div class="bg-gray-800 rounded-2xl p-8 shadow-xl">
    <h1 class="text-3xl font-bold text-center mb-8 flex items-center justify-center gap-2"><i data-lucide="gamepad-2" class="w-8 h-8"></i> 방 만들기</h1>

    <form x-data="createRoomForm()" @submit.prevent="submit()" class="space-y-6">
      <!-- 방 이름 -->
      <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">방 이름</label>
        <input
          type="text"
          x-model="roomName"
          placeholder="방 이름을 입력하세요"
          maxlength="20"
          required
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
        >
      </div>

      <!-- 공개/비공개 -->
      <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">공개 설정</label>
        <div class="flex gap-4">
          <button type="button" @click="isPublic = true" class="flex-1">
            <div class="p-4 bg-gray-700 rounded-lg text-center transition-all flex items-center justify-center gap-2" :class="isPublic && 'bg-primary ring-2 ring-primary/50'">
              <i data-lucide="globe" class="w-5 h-5"></i> 공개
            </div>
          </button>
          <button type="button" @click="isPublic = false" class="flex-1">
            <div class="p-4 bg-gray-700 rounded-lg text-center transition-all flex items-center justify-center gap-2" :class="!isPublic && 'bg-primary ring-2 ring-primary/50'">
              <i data-lucide="lock" class="w-5 h-5"></i> 비공개
            </div>
          </button>
        </div>
      </div>

      <!-- 비밀번호 (비공개 방) -->
      <div x-show="!isPublic" x-transition>
        <label class="block text-sm font-medium text-gray-300 mb-2">비밀번호</label>
        <input
          type="password"
          x-model="password"
          placeholder="비밀번호를 입력하세요"
          minlength="1"
          maxlength="20"
          :required="!isPublic"
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
        >
        <p class="text-xs text-gray-500 mt-1">참가자가 방에 들어올 때 입력해야 합니다</p>
      </div>

      <p class="text-sm text-gray-400 text-center">게임 설정은 대기실에서 변경할 수 있습니다</p>

      <!-- 에러 메시지 -->
      <div x-show="error" x-text="error" class="text-red-400 text-sm text-center"></div>

      <!-- 제출 버튼 -->
      <button
        type="submit"
        :disabled="loading"
        class="w-full py-4 bg-gradient-to-r from-primary to-secondary rounded-lg font-bold text-lg hover:opacity-90 transition-opacity disabled:opacity-50"
      >
        <span x-show="!loading">방 만들기</span>
        <span x-show="loading">생성 중...</span>
      </button>
    </form>
  </div>
</div>

<script>
function createRoomForm() {
  return {
    roomName: '',
    isPublic: true,
    password: '',
    loading: false,
    error: '',

    submit() {
      if (!this.roomName) {
        this.error = '방 이름을 입력하세요.';
        return;
      }
      if (!this.isPublic && !this.password) {
        this.error = '비공개 방은 비밀번호가 필요합니다.';
        return;
      }

      this.loading = true;
      this.error = '';

      // Socket.IO 연결 및 방 생성
      const socket = io();

      socket.on('connect', () => {
        socket.emit('create-room', {
          roomName: this.roomName,
          isPublic: this.isPublic,
          password: this.isPublic ? null : this.password
        });
      });

      socket.on('room-created', (data) => {
        // hostToken을 sessionStorage에 저장 (URL에 노출하지 않음)
        sessionStorage.setItem(`hostToken_${data.roomId}`, data.hostToken);

        let url = '/room/' + data.roomId;
        // 비공개 방인 경우 비밀번호만 전달
        if (!this.isPublic && this.password) {
          url += '?password=' + encodeURIComponent(this.password);
        }
        window.location.href = url;
      });

      socket.on('error', (data) => {
        this.error = data.message;
        this.loading = false;
      });
    }
  }
}
</script>
<%- include('partials/scripts') %>
</body>
</html>
