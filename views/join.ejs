<%- include('layout', { body: `
<div class="container mx-auto px-4 py-8 max-w-lg">
  <a href="/" class="inline-flex items-center gap-2 text-gray-400 hover:text-white mb-8 transition-colors">
    â† ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°
  </a>

  <div class="bg-gray-800 rounded-2xl p-8 shadow-xl">
    <h1 class="text-3xl font-bold text-center mb-8">ğŸšª ë°© ì°¸ê°€í•˜ê¸°</h1>

    <form x-data="joinRoomForm()" @submit.prevent="submit()" class="space-y-6">
      <!-- ë‹‰ë„¤ì„ -->
      <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">ë‹‰ë„¤ì„</label>
        <input
          type="text"
          x-model="nickname"
          placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
          minlength="2"
          maxlength="10"
          required
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
        >
      </div>

      <!-- ë°© ì½”ë“œ -->
      <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">ë°© ì½”ë“œ</label>
        <input
          type="text"
          x-model="roomCode"
          placeholder="6ìë¦¬ ë°© ì½”ë“œ"
          maxlength="6"
          required
          @input="roomCode = roomCode.toUpperCase()"
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-center text-2xl tracking-widest font-mono"
        >
      </div>

      <!-- ë°© ìƒíƒœ í™•ì¸ -->
      <div x-show="roomStatus" class="text-center py-2">
        <span x-show="roomStatus === 'checking'" class="text-gray-400">í™•ì¸ ì¤‘...</span>
        <span x-show="roomStatus === 'available'" class="text-green-400">âœ“ ì°¸ê°€ ê°€ëŠ¥</span>
        <span x-show="roomStatus === 'not-found'" class="text-red-400">âœ— ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>
        <span x-show="roomStatus === 'full'" class="text-yellow-400">âš  ë°©ì´ ê°€ë“ ì°¼ê±°ë‚˜ ê²Œì„ ì¤‘ì…ë‹ˆë‹¤</span>
      </div>

      <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
      <div x-show="error" x-text="error" class="text-red-400 text-sm text-center"></div>

      <!-- ì œì¶œ ë²„íŠ¼ -->
      <button
        type="submit"
        :disabled="loading || roomCode.length !== 6"
        class="w-full py-4 bg-gradient-to-r from-primary to-secondary rounded-lg font-bold text-lg hover:opacity-90 transition-opacity disabled:opacity-50"
      >
        <span x-show="!loading">ì°¸ê°€í•˜ê¸°</span>
        <span x-show="loading">ì°¸ê°€ ì¤‘...</span>
      </button>
    </form>
  </div>
</div>

<script>
function joinRoomForm() {
  return {
    nickname: localStorage.getItem('nickname') || generateRandomNickname(),
    roomCode: '${code}'.toUpperCase(),
    loading: false,
    error: '',
    roomStatus: '',
    checkTimeout: null,

    init() {
      this.$watch('roomCode', (value) => {
        if (this.checkTimeout) clearTimeout(this.checkTimeout);
        if (value.length === 6) {
          this.checkTimeout = setTimeout(() => this.checkRoom(), 300);
        } else {
          this.roomStatus = '';
        }
      });

      if (this.roomCode.length === 6) {
        this.checkRoom();
      }
    },

    async checkRoom() {
      this.roomStatus = 'checking';
      try {
        const res = await fetch('/api/rooms/' + this.roomCode);
        if (res.ok) {
          const data = await res.json();
          this.roomStatus = data.canJoin ? 'available' : 'full';
        } else {
          this.roomStatus = 'not-found';
        }
      } catch (e) {
        this.roomStatus = '';
      }
    },

    submit() {
      if (this.nickname.length < 2 || this.nickname.length > 10) {
        this.error = 'ë‹‰ë„¤ì„ì€ 2-10ì ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.';
        return;
      }
      if (this.roomCode.length !== 6) {
        this.error = 'ì˜¬ë°”ë¥¸ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
        return;
      }

      this.loading = true;
      this.error = '';

      // ë‹‰ë„¤ì„ ì €ì¥
      localStorage.setItem('nickname', this.nickname);

      // ë°© ì°¸ê°€
      window.location.href = '/room/' + this.roomCode + '?nickname=' + encodeURIComponent(this.nickname);
    }
  }
}
</script>
` }) %>
