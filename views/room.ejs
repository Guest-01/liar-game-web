<!DOCTYPE html>
<html lang="ko">
<head>
  <%- include('partials/head') %>
</head>
<body class="bg-gray-900 text-white min-h-screen">
<div x-data="gameRoom()" x-init="init()" class="min-h-screen flex flex-col">
  <!-- 상단 바 -->
  <header class="bg-gray-800 border-b border-gray-700">
    <div class="container mx-auto max-w-6xl px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2 min-w-0 flex-1 mr-4">
        <h1 class="text-xl font-bold truncate min-w-0" x-text="room.name || '로딩 중...'"></h1>
        <span class="text-gray-400 font-normal text-base flex items-center gap-1 flex-shrink-0" x-show="room.category">
          <span>|</span>
          <i data-lucide="folder" class="w-4 h-4"></i>
          <span x-text="room.category"></span>
        </span>
        <span x-show="myWord.word || myWord.isLiar" class="text-gray-400 font-normal text-base flex items-center gap-1 flex-shrink-0">
          <span>-</span>
          <span x-show="myWord.isLiar" class="text-red-400">라이어</span>
          <span x-show="!myWord.isLiar" x-text="myWord.word" class="text-primary"></span>
        </span>
      </div>
      <div class="flex items-center gap-4">
        <button @click="leaveRoom()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
          나가기
        </button>
      </div>
    </div>
  </header>

  <!-- 닉네임 입력 모달 (방에 참가하지 않은 경우) -->
  <div x-show="!joined && !connecting" x-cloak class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-2xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold mb-6 text-center">방에 참가하기</h2>
      <form @submit.prevent="joinRoom()">
        <input
          type="text"
          x-model="nickname"
          placeholder="닉네임 (2-10자)"
          minlength="2"
          maxlength="10"
          required
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg mb-4 focus:ring-2 focus:ring-primary outline-none"
        >
        <!-- 비공개 방인 경우 비밀번호 입력 -->
        <div x-show="!room.isPublic" class="mb-4">
          <input
            type="password"
            x-model="passwordInput"
            placeholder="비밀번호"
            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary outline-none"
          >
        </div>
        <div x-show="error" x-text="error" class="text-red-400 text-sm mb-4 text-center"></div>
        <button type="submit" class="w-full py-3 bg-primary hover:bg-primary/80 rounded-lg font-bold">
          참가하기
        </button>
      </form>
    </div>
  </div>

  <!-- 연결 중 -->
  <div x-show="connecting" x-cloak class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="text-center">
      <i data-lucide="loader" class="w-10 h-10 animate-spin mb-4"></i>
      <p>연결 중...</p>
    </div>
  </div>

  <!-- 메인 컨텐츠 -->
  <main class="flex-1 container mx-auto p-4 max-w-6xl" x-show="joined">
    <div class="lg:grid lg:grid-cols-5 lg:gap-6">
      <!-- 메인 콘텐츠 영역 (3/5) -->
      <div class="lg:col-span-3 flex flex-col gap-6">

        <!-- ==================== 대기실 ==================== -->
        <div x-show="room.state === 'waiting'" class="space-y-6">
          <!-- 게임 설정 (호스트만 수정 가능) -->
          <div class="bg-gray-800 rounded-xl p-6">
            <h3 class="font-semibold mb-4 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5"></i> 게임 설정</h3>

            <!-- 비호스트: 읽기 전용 -->
            <div x-show="!isHost" class="flex flex-wrap gap-4 text-sm text-gray-400">
              <span class="flex items-center gap-1"><i data-lucide="target" class="w-4 h-4"></i> 모드: <span class="text-white" x-text="room.gameMode === 'normal' ? '일반' : '바보'"></span></span>
              <span class="flex items-center gap-1"><i data-lucide="folder" class="w-4 h-4"></i> 카테고리: <span class="text-white" x-text="room.category"></span></span>
              <span class="flex items-center gap-1"><i data-lucide="users" class="w-4 h-4"></i> 최대: <span class="text-white" x-text="room.maxPlayers + '명'"></span></span>
              <span class="flex items-center gap-1"><i data-lucide="timer" class="w-4 h-4"></i> 설명: <span class="text-white" x-text="room.descriptionTime + '초'"></span></span>
              <span class="flex items-center gap-1"><i data-lucide="message-circle" class="w-4 h-4"></i> 토론: <span class="text-white" x-text="Math.floor(room.discussionTime / 60) + '분'"></span></span>
              <span class="flex items-center gap-1"><i data-lucide="mic" class="w-4 h-4"></i> 변론: <span class="text-white" x-text="room.defenseTime + '초'"></span></span>
            </div>

            <!-- 호스트: 수정 가능 -->
            <div x-show="isHost" class="flex flex-col gap-4">
              <!-- 게임 모드 -->
              <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm text-gray-400 w-20 flex items-center gap-1">
                  게임 모드
                  <span class="relative group">
                    <i data-lucide="help-circle" class="w-3.5 h-3.5 text-gray-500 cursor-help"></i>
                    <div class="absolute left-0 bottom-full mb-2 w-56 p-2 bg-gray-900 text-xs text-gray-300 rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10 shadow-lg">
                      <p class="mb-1"><strong class="text-white">일반:</strong> 라이어는 제시어 없이 유추해야 함</p>
                      <p><strong class="text-white">바보:</strong> 라이어도 자신이 라이어인지 모름</p>
                    </div>
                  </span>
                </span>
                <div class="flex gap-3">
                  <button type="button" @click="updateSetting('gameMode', 'normal')"
                    class="w-20 md:w-24 py-2 rounded-lg text-sm transition-all flex items-center justify-center gap-1"
                    :class="room.gameMode === 'normal' ? 'bg-primary' : 'bg-gray-700 hover:bg-gray-600'">
                    <i data-lucide="target" class="w-4 h-4"></i> 일반
                  </button>
                  <button type="button" @click="updateSetting('gameMode', 'fool')"
                    class="w-20 md:w-24 py-2 rounded-lg text-sm transition-all flex items-center justify-center gap-1"
                    :class="room.gameMode === 'fool' ? 'bg-primary' : 'bg-gray-700 hover:bg-gray-600'">
                    <i data-lucide="smile" class="w-4 h-4"></i> 바보
                  </button>
                </div>
              </div>

              <!-- 카테고리 -->
              <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm text-gray-400 w-20">카테고리</span>
                <!-- 데스크톱: 버튼 -->
                <div class="hidden lg:flex flex-wrap gap-2">
                  <button type="button" @click="updateSetting('category', '랜덤')"
                    class="w-16 py-1.5 rounded text-xs transition-all text-center"
                    :class="room.category === '랜덤' ? 'bg-primary' : 'bg-gray-700 hover:bg-gray-600'">
                    랜덤
                  </button>
                  <template x-for="cat in categories" :key="cat">
                    <button type="button" @click="updateSetting('category', cat)"
                      class="w-16 py-1.5 rounded text-xs transition-all text-center"
                      :class="room.category === cat ? 'bg-primary' : 'bg-gray-700 hover:bg-gray-600'"
                      x-text="cat"></button>
                  </template>
                </div>
                <!-- 모바일: 드롭다운 -->
                <select @change="updateSetting('category', $event.target.value)"
                  class="lg:hidden px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none">
                  <option value="랜덤" :selected="room.category === '랜덤'">랜덤</option>
                  <template x-for="cat in categories" :key="cat">
                    <option :value="cat" :selected="room.category === cat" x-text="cat"></option>
                  </template>
                </select>
              </div>

              <!-- 최대 인원 -->
              <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm text-gray-400 w-20">최대 인원</span>
                <div class="flex items-center gap-3">
                  <input type="range" min="3" max="10" :value="room.maxPlayers"
                    @input="updateSetting('maxPlayers', parseInt($event.target.value))"
                    class="w-32 md:w-40 lg:w-48 accent-primary">
                  <span class="text-white font-medium" x-text="room.maxPlayers + '명'"></span>
                </div>
              </div>

              <!-- 시간 설정 (제네릭 컴포넌트) -->
              <template x-for="setting in timeSettings" :key="setting.key">
                <div class="flex flex-wrap items-center gap-4">
                  <span class="text-sm text-gray-400 w-20" x-text="setting.label"></span>
                  <!-- 데스크톱: 버튼 -->
                  <div class="hidden lg:flex gap-2">
                    <template x-for="val in setting.values" :key="val">
                      <button type="button" @click="updateSetting(setting.key, val)"
                        class="w-14 py-1.5 rounded text-xs transition-all text-center"
                        :class="room[setting.key] === val ? 'bg-primary' : 'bg-gray-700 hover:bg-gray-600'"
                        x-text="setting.format(val)"></button>
                    </template>
                  </div>
                  <!-- 모바일: 드롭다운 -->
                  <select @change="updateSetting(setting.key, parseInt($event.target.value))"
                    class="lg:hidden px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none">
                    <template x-for="val in setting.values" :key="val">
                      <option :value="val" :selected="room[setting.key] === val" x-text="setting.format(val)"></option>
                    </template>
                  </select>
                </div>
              </template>
            </div>
          </div>

          <!-- 모바일: 플레이어 목록 -->
          <div class="lg:hidden">
            <%- include('partials/player-list') %>
          </div>

          <!-- 게임 시작 버튼 -->
          <div x-show="isHost" class="text-center">
            <button
              @click="startGame()"
              :disabled="room.players?.length < 3"
              class="w-full lg:w-auto px-8 py-4 bg-gradient-to-r from-primary to-secondary rounded-xl font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span x-show="room.players?.length >= 3" class="flex items-center justify-center gap-2"><i data-lucide="gamepad-2" class="w-5 h-5"></i> 게임 시작</span>
              <span x-show="room.players?.length < 3">최소 3명이 필요합니다</span>
            </button>
          </div>
          <div x-show="!isHost" class="text-center text-gray-400">
            호스트가 게임을 시작할 때까지 기다려주세요...
          </div>
        </div>

        <!-- ==================== 단어 확인 / 순서 결정 ==================== -->
        <div x-show="room.state === 'word-check' || shuffleAnimation" class="text-center py-12">
          <!-- 제시어 확인 UI -->
          <div x-show="!shuffleAnimation">
            <h2 class="text-2xl font-bold mb-8 flex items-center justify-center gap-2"><i data-lucide="search" class="w-7 h-7"></i> 당신의 제시어</h2>

            <div
              x-show="!wordRevealed"
              @click="wordRevealed = true"
              class="inline-block px-12 py-8 bg-gray-800 rounded-2xl cursor-pointer hover:bg-gray-750 transition-colors border-2 border-dashed border-gray-600"
            >
              <p class="text-gray-400">탭하여 확인</p>
            </div>

            <div x-show="wordRevealed" class="space-y-6 fade-in">
              <!-- 카드 컨테이너 (시민/라이어 같은 위치) -->
              <div class="grid place-items-center">
                <!-- 시민 또는 바보모드 -->
                <div x-show="!myWord.isLiar" class="col-start-1 row-start-1 inline-block px-12 py-8 bg-gradient-to-br from-primary to-secondary rounded-2xl">
                  <p class="text-sm mb-2 text-indigo-200">주제: <span class="font-semibold text-white" x-text="room.category"></span></p>
                  <p class="text-4xl font-bold" x-text="myWord.word"></p>
                </div>
                <!-- 일반모드 라이어 -->
                <div x-show="myWord.isLiar" class="col-start-1 row-start-1 inline-block px-12 py-8 bg-gradient-to-br from-red-700 to-red-900 rounded-2xl border-2 border-red-400/50">
                  <p class="text-sm mb-2 text-red-200">주제: <span class="font-semibold text-white" x-text="room.category"></span></p>
                  <p class="text-xl md:text-3xl font-bold flex items-center justify-center gap-2"><i data-lucide="drama" class="w-6 h-6 md:w-8 md:h-8"></i> 당신은 라이어입니다!</p>
                </div>
              </div>

              <!-- 바보 모드 안내 -->
              <p x-show="room.gameMode === 'fool'" class="text-gray-400 text-sm">
                <i data-lucide="help-circle" class="w-4 h-4 inline"></i>
                바보 모드: 당신이 라이어인지 아닌지 알 수 없습니다!
              </p>

              <button
                @click="confirmWord()"
                :disabled="wordChecked"
                class="block mx-auto px-8 py-3 bg-primary hover:bg-primary/80 rounded-lg font-semibold disabled:opacity-50"
              >
                <span x-show="!wordChecked">확인 완료</span>
                <span x-show="wordChecked">대기 중... (<span x-text="checkedCount"></span>/<span x-text="room.players?.length"></span>)</span>
              </button>
            </div>
          </div>

          <!-- 순서 결정 애니메이션 UI -->
          <div x-show="shuffleAnimation">
            <h2 class="text-2xl font-bold mb-8 flex items-center justify-center gap-2">
              <i data-lucide="shuffle" class="w-7 h-7"></i> 첫 순서를 정하는 중...
            </h2>
            <div class="bg-gray-800 rounded-xl p-6 max-w-md mx-auto">
              <div class="space-y-2">
                <template x-for="(player, index) in room.players" :key="player.id">
                  <div
                    class="p-3 rounded-lg transition-all duration-100"
                    :class="shuffleHighlightIndex === index ? 'bg-primary text-white scale-105 shadow-lg shadow-primary/30' : 'bg-gray-700'"
                  >
                    <span x-text="player.nickname"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== 한줄 설명 ==================== -->
        <div x-show="room.state === 'description'" class="space-y-6">
          <div class="flex flex-col gap-4 items-center text-center">
            <div>
              <h2 class="text-2xl font-bold mb-2 flex items-center justify-center gap-2"><i data-lucide="pencil" class="w-7 h-7"></i> 한줄 설명</h2>
              <p class="text-gray-400">제시어를 직접 말하지 않고 설명하세요!</p>
            </div>
            <div class="inline-flex items-center gap-2 px-6 py-3 bg-gray-800 rounded-full">
              <i data-lucide="timer" class="w-5 h-5"></i>
              <span class="text-2xl font-mono font-bold" :class="timer <= 5 && timer > 0 ? 'timer-warning' : ''" x-text="formatTime(timer)"></span>
            </div>
          </div>

          <!-- 현재 차례 + 진행률 -->
          <div class="bg-gray-800 rounded-xl p-6 text-center">
            <template x-if="currentDescriber">
              <div>
                <p class="text-gray-400 mb-2">
                  현재 차례
                  <span class="text-primary font-mono">(<span x-text="currentDescriberIndex + 1"></span>/<span x-text="room.players?.length"></span>)</span>
                </p>
                <p class="text-2xl font-bold" x-text="currentDescriber.nickname"></p>
                <p x-show="currentDescriber.id === playerId" class="text-primary mt-2">(당신의 차례입니다!)</p>
              </div>
            </template>
          </div>

          <!-- 입력 (내 차례일 때) -->
          <div x-show="currentDescriber?.id === playerId && !myDescriptionSubmitted" class="bg-gray-800 rounded-xl p-6">
            <form @submit.prevent="submitDescription()">
              <input
                type="text"
                x-model="descriptionInput"
                x-ref="descriptionInput"
                placeholder="제시어에 대한 한줄 설명을 입력하세요"
                maxlength="100"
                class="w-full px-4 py-3 bg-gray-700 rounded-lg mb-4 focus:ring-2 focus:ring-primary outline-none"
              >
              <button type="submit" class="w-full py-3 bg-primary hover:bg-primary/80 rounded-lg font-semibold">
                제출
              </button>
            </form>
          </div>

          <!-- 제출된 설명들 -->
          <div class="bg-gray-800 rounded-xl p-6">
            <h3 class="font-semibold mb-4">
              제출된 설명
              <span class="text-gray-400 font-normal">(<span x-text="Object.keys(descriptions).length"></span>/<span x-text="room.players?.length"></span>)</span>
            </h3>
            <div class="space-y-3">
              <template x-for="(desc, pid) in descriptions" :key="pid">
                <div class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg">
                  <span class="font-medium" x-text="getPlayerNickname(pid) + ':'"></span>
                  <span class="text-gray-300" x-text="desc"></span>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- ==================== 토론 + 지목 ==================== -->
        <div x-show="room.state === 'discussion'" class="flex flex-col gap-4">
          <div class="flex justify-between items-center">
            <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="message-circle" class="w-6 h-6"></i> 토론</h2>
            <div class="px-4 py-2 bg-gray-800 rounded-full flex items-center gap-2">
              <i data-lucide="timer" class="w-4 h-4"></i> <span class="font-mono" :class="timer <= 5 && timer > 0 ? 'timer-warning' : ''" x-text="formatTime(timer)"></span>
            </div>
          </div>

          <!-- 설명 목록 + 지목 -->
          <div class="bg-gray-800 rounded-xl p-4">
            <h3 class="text-sm text-gray-400 mb-3 flex items-center gap-1"><i data-lucide="pencil" class="w-4 h-4"></i> 한줄 설명 목록</h3>
            <div class="grid gap-2">
              <template x-for="player in room.players" :key="player.id">
                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                  <div class="min-w-0 flex-1 mr-2">
                    <span class="font-medium" x-text="player.nickname"></span><span x-show="player.id === playerId" class="text-primary text-sm">(나)</span>:
                    <span class="text-gray-300" x-text="descriptions[player.id] || '...'"></span>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    <span class="text-xs text-gray-400" x-text="getNominationCount(player.id) + '표'"></span>
                    <button
                      x-show="player.id !== playerId"
                      @click="nominate(player.id)"
                      class="px-3 py-1 rounded-lg text-sm transition-colors"
                      :class="myNomination === player.id ? 'bg-danger' : 'bg-gray-600 hover:bg-gray-500'"
                    >
                      <span x-show="myNomination === player.id" class="flex items-center gap-1"><i data-lucide="hand" class="w-4 h-4"></i> 지목함</span>
                      <span x-show="myNomination !== player.id">지목</span>
                    </button>
                  </div>
                </div>
              </template>

              <!-- 한줄 설명 다시하기 선택지 -->
              <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg border border-dashed border-yellow-600/50">
                <div class="flex items-center gap-2">
                  <i data-lucide="refresh-cw" class="w-5 h-5 text-yellow-400"></i>
                  <span class="font-medium text-yellow-400">한줄 설명 다시하기</span>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <span class="text-xs text-gray-400" x-text="getNominationCount(REDO_DESCRIPTION_ID) + '표'"></span>
                  <button
                    @click="nominate(REDO_DESCRIPTION_ID)"
                    class="px-3 py-1 rounded-lg text-sm transition-colors"
                    :class="myNomination === REDO_DESCRIPTION_ID ? 'bg-yellow-600' : 'bg-gray-600 hover:bg-gray-500'"
                  >
                    <span x-show="myNomination === REDO_DESCRIPTION_ID" class="flex items-center gap-1"><i data-lucide="hand" class="w-4 h-4"></i> 지목함</span>
                    <span x-show="myNomination !== REDO_DESCRIPTION_ID">지목</span>
                  </button>
                </div>
              </div>
            </div>
            <p class="text-xs text-gray-500 text-center mt-2 flex items-center justify-center gap-1">
              <i data-lucide="info" class="w-3 h-3"></i>
              모두가 지목을 완료하면 타이머가 5초로 줄어듭니다
            </p>
          </div>

        </div>

        <!-- ==================== 최후 변론 ==================== -->
        <div x-show="room.state === 'defense'" class="space-y-6">
          <div class="flex flex-col gap-4 items-center text-center">
            <h2 class="text-2xl font-bold flex items-center justify-center gap-2"><i data-lucide="mic" class="w-7 h-7"></i> 최후 변론</h2>
            <div class="px-6 py-3 bg-gray-800 rounded-full inline-flex items-center gap-2">
              <i data-lucide="timer" class="w-5 h-5"></i> <span class="font-mono text-2xl" :class="timer <= 5 && timer > 0 ? 'timer-warning' : ''" x-text="formatTime(timer)"></span>
            </div>
          </div>

          <!-- 변론자 정보 -->
          <div class="bg-gray-800 rounded-xl p-8 text-center">
            <p class="text-gray-400 mb-2">변론자</p>
            <p class="text-3xl font-bold" x-text="getPlayerNickname(defenderId)"></p>
            <p x-show="defenderId === playerId" class="text-primary mt-4">당신의 변론 시간입니다!</p>
            <button x-show="defenderId === playerId" @click="endDefense()"
              class="mt-4 px-6 py-2 bg-danger hover:bg-danger/80 rounded-lg font-semibold flex items-center gap-2 mx-auto">
              <i data-lucide="square" class="w-4 h-4 fill-current"></i> 변론 종료
            </button>
          </div>

        </div>

        <!-- ==================== 최종 투표 ==================== -->
        <div x-show="room.state === 'final-vote'" class="space-y-6 text-center">
          <div class="text-center">
            <h2 class="text-2xl font-bold flex items-center justify-center gap-2"><i data-lucide="vote" class="w-7 h-7"></i> 최종 투표</h2>
            <div x-show="!voteResult" class="inline-flex items-center gap-2 px-6 py-3 bg-gray-800 rounded-full mt-4">
              <i data-lucide="timer" class="w-5 h-5"></i>
              <span class="text-2xl font-mono font-bold" :class="timer <= 5 && timer > 0 ? 'timer-warning' : ''" x-text="formatTime(timer)"></span>
            </div>
          </div>

          <!-- 투표 중 UI (결과가 없을 때) -->
          <div x-show="!voteResult" class="bg-gray-800 rounded-xl p-8">
            <p class="text-gray-400 mb-2">이 사람이 라이어입니까?</p>
            <p class="text-3xl font-bold mb-6" x-text="getPlayerNickname(defenderId)"></p>

            <div x-show="defenderId !== playerId && myFinalVote === null" class="flex justify-center gap-3 md:gap-4">
              <button @click="finalVote(true)" class="px-5 py-3 md:px-8 md:py-4 bg-success hover:bg-success/80 rounded-xl font-bold text-lg md:text-xl flex items-center gap-1.5 md:gap-2 whitespace-nowrap">
                <i data-lucide="check" class="w-5 h-5 md:w-6 md:h-6"></i> 찬성
              </button>
              <button @click="finalVote(false)" class="px-5 py-3 md:px-8 md:py-4 bg-danger hover:bg-danger/80 rounded-xl font-bold text-lg md:text-xl flex items-center gap-1.5 md:gap-2 whitespace-nowrap">
                <i data-lucide="x" class="w-5 h-5 md:w-6 md:h-6"></i> 반대
              </button>
            </div>

            <div x-show="defenderId === playerId" class="text-gray-400">
              당신은 투표할 수 없습니다.
            </div>

            <div x-show="myFinalVote !== null" class="text-gray-400">
              투표 완료! 결과를 기다리는 중...
              (<span x-text="finalVoteCount"></span>/<span x-text="room.players?.length - 1"></span>)
            </div>
          </div>

          <!-- 투표 결과 UI (결과가 있을 때) -->
          <div x-show="voteResult" class="bg-gray-800 rounded-xl p-8 space-y-6">
            <div>
              <p class="text-gray-400 mb-2">투표 결과</p>
              <div class="flex justify-center items-center gap-2 md:gap-4 text-lg md:text-2xl flex-wrap">
                <span class="text-success font-bold flex items-center gap-1">
                  <i data-lucide="check" class="w-5 h-5 md:w-6 md:h-6"></i>
                  찬성 <span x-text="voteResult?.agree"></span>표
                </span>
                <span class="text-gray-500">/</span>
                <span class="text-danger font-bold flex items-center gap-1">
                  <i data-lucide="x" class="w-5 h-5 md:w-6 md:h-6"></i>
                  반대 <span x-text="voteResult?.disagree"></span>표
                </span>
                <span x-show="voteResult?.abstain > 0" class="text-gray-500 flex items-center gap-1">
                  / <i data-lucide="minus" class="w-5 h-5 md:w-6 md:h-6"></i>
                  무효 <span x-text="voteResult?.abstain"></span>표
                </span>
              </div>
            </div>

            <div class="border-t border-gray-700 pt-6">
              <p x-show="voteResult?.confirmed" class="text-xl text-success flex items-center justify-center gap-2">
                <i data-lucide="check-circle" class="w-6 h-6"></i>
                과반수 찬성!
              </p>
              <p x-show="!voteResult?.confirmed" class="text-xl text-warning flex items-center justify-center gap-2">
                <i data-lucide="alert-circle" class="w-6 h-6"></i>
                과반수 미달
              </p>
              <p class="text-gray-400 mt-4">
                <span x-text="voteResult?.countdown"></span>초 후
                <span x-show="voteResult?.confirmed">라이어를 공개합니다...</span>
                <span x-show="!voteResult?.confirmed">토론으로 돌아갑니다...</span>
              </p>
            </div>
          </div>
        </div>

        <!-- ==================== 라이어 정답 맞추기 ==================== -->
        <div x-show="room.state === 'liar-guess'" class="space-y-6 text-center">
          <div class="flex flex-col gap-4 items-center">
            <h2 class="text-2xl font-bold flex items-center justify-center gap-2"><i data-lucide="target" class="w-7 h-7"></i> 정답 맞추기</h2>
            <div class="inline-flex items-center gap-2 px-6 py-3 bg-gray-800 rounded-full">
              <i data-lucide="timer" class="w-5 h-5"></i>
              <span class="text-2xl font-mono font-bold" :class="timer <= 5 && timer > 0 ? 'timer-warning' : ''" x-text="formatTime(timer)"></span>
            </div>
          </div>

          <!-- 라이어를 맞췄다는 알림 -->
          <div class="bg-success/20 border border-success rounded-xl p-4">
            <p class="text-success text-base md:text-lg font-bold flex items-center justify-center gap-2">
              <i data-lucide="check-circle" class="w-5 h-5"></i>
              <span x-text="getPlayerNickname(defenderId)"></span>님은 라이어가 맞았습니다!
            </p>
          </div>

          <div x-show="playerId === liarId" class="bg-gray-800 rounded-xl p-8">
            <p class="text-gray-400 mb-4">시민들의 제시어를 맞춰보세요!</p>
            <form @submit.prevent="submitLiarGuess()">
              <input
                type="text"
                x-model="liarGuessInput"
                x-ref="liarGuessInput"
                placeholder="제시어를 입력하세요"
                class="w-full px-4 py-3 bg-gray-700 rounded-lg mb-4 text-center text-xl focus:ring-2 focus:ring-primary outline-none"
              >
              <button type="submit" class="px-8 py-3 bg-primary hover:bg-primary/80 rounded-lg font-bold">
                제출
              </button>
            </form>
          </div>

          <div x-show="playerId !== liarId" class="bg-gray-800 rounded-xl p-8">
            <p class="text-gray-400">라이어가 정답을 맞추는 중...</p>
          </div>
        </div>

        <!-- ==================== 결과 ==================== -->
        <div x-show="room.state === 'result'" class="space-y-6 text-center">
          <h2 class="text-3xl font-bold mb-8 flex items-center justify-center gap-2">
            <i x-show="gameResult?.winner === 'citizen'" data-lucide="party-popper" class="w-8 h-8"></i>
            <i x-show="gameResult?.winner !== 'citizen'" data-lucide="drama" class="w-8 h-8"></i>
            <span x-text="gameResult?.winner === 'citizen' ? '시민 승리!' : '라이어 승리!'"></span>
          </h2>

          <div class="bg-gray-800 rounded-xl p-8 flex flex-col gap-4">
            <div>
              <p class="text-gray-400">라이어</p>
              <p class="text-2xl font-bold text-danger" x-text="getPlayerNickname(gameResult?.liarId)"></p>
            </div>

            <div class="border-t border-gray-700 pt-4">
              <p class="text-gray-400">시민 제시어</p>
              <p class="text-2xl font-bold text-primary" x-text="gameResult?.citizenWord"></p>
            </div>

            <div x-show="gameResult?.liarWord" class="border-t border-gray-700 pt-4">
              <p class="text-gray-400">라이어 제시어</p>
              <p class="text-2xl font-bold text-secondary" x-text="gameResult?.liarWord"></p>
            </div>

            <div x-show="gameResult?.wasLiarCaught" class="border-t border-gray-700 pt-4">
              <p class="text-gray-400">라이어가 추측한 답</p>
              <p class="text-xl" x-text="gameResult?.liarGuess || '(제출 안 함)'"></p>
              <p x-show="gameResult?.liarGuessedCorrectly" class="text-success flex items-center justify-center gap-1"><i data-lucide="check" class="w-5 h-5"></i> 정답! 역전 승리!</p>
              <p x-show="!gameResult?.liarGuessedCorrectly && gameResult?.liarGuess" class="text-danger flex items-center justify-center gap-1"><i data-lucide="x" class="w-5 h-5"></i> 오답</p>
            </div>
          </div>

          <div x-show="isHost">
            <button @click="restartGame()" class="px-8 py-4 bg-gradient-to-r from-primary to-secondary rounded-xl font-bold text-lg flex items-center gap-2 mx-auto">
              <i data-lucide="refresh-cw" class="w-5 h-5"></i> 다시 하기
            </button>
          </div>
          <div x-show="!isHost" class="text-gray-400">
            호스트가 게임을 재시작할 때까지 기다려주세요...
          </div>
        </div>

      </div>

      <!-- ==================== 사이드바 (데스크톱 전용) ==================== -->
      <aside class="hidden lg:flex lg:col-span-2 flex-col gap-4 h-[calc(100vh-8rem)] sticky top-4">
        <%- include('partials/player-list') %>
        <%- include('partials/chat') %>
      </aside>

    </div>
  </main>

  <!-- ==================== 모바일 플로팅 채팅 버튼 + 미리보기 ==================== -->
  <div class="lg:hidden fixed bottom-6 right-6 z-50 flex items-end gap-3" x-show="joined && !mobileChatOpen" x-cloak>
    <!-- 메시지 미리보기 -->
    <div x-show="previewMessage" x-cloak
      @click="hidePreviewAndOpenChat()"
      class="max-w-[200px] bg-gray-800 rounded-xl px-3 py-2 shadow-lg cursor-pointer border border-gray-700"
      x-transition:enter="transition ease-out duration-150"
      x-transition:enter-start="opacity-0 translate-x-2"
      x-transition:enter-end="opacity-100 translate-x-0"
      x-transition:leave="transition ease-in duration-100"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0">
      <p class="text-xs text-primary font-medium truncate" x-text="previewMessage?.nickname"></p>
      <p class="text-sm text-white truncate" x-text="previewMessage?.message"></p>
    </div>

    <!-- 플로팅 버튼 -->
    <button @click="openMobileChat()"
      class="w-14 h-14 bg-primary hover:bg-primary/80 rounded-full shadow-lg flex items-center justify-center relative transition-transform active:scale-95 flex-shrink-0"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-90"
      x-transition:enter-end="opacity-100 scale-100">
      <i data-lucide="message-circle" class="w-6 h-6"></i>
      <!-- 새 메시지 알림 점 -->
      <span x-show="unreadCount > 0"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="scale-0"
        x-transition:enter-end="scale-100"
        class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs font-bold animate-pulse">
        <span x-text="unreadCount > 9 ? '9+' : unreadCount"></span>
      </span>
    </button>
  </div>

  <!-- ==================== 모바일 채팅 오버레이 ==================== -->
  <div x-show="mobileChatOpen" x-cloak class="lg:hidden fixed inset-0 z-50">

    <!-- 배경 딤 -->
    <div @click="closeMobileChat()"
      class="absolute inset-0 bg-black/50 mobile-chat-backdrop"
      :class="{ 'open': mobileChatOpen && !mobileChatClosing }"></div>

    <!-- 채팅창 (하단 60%) -->
    <div class="absolute bottom-0 left-0 right-0 h-[60vh] bg-gray-800 rounded-t-2xl flex flex-col mobile-chat-panel"
      :class="{ 'open': mobileChatOpen && !mobileChatClosing, 'closing': mobileChatClosing }">

      <!-- 드래그 핸들 (스와이프 영역) -->
      <div class="flex justify-center py-3 flex-shrink-0 cursor-grab active:cursor-grabbing"
        @touchstart="handleSwipeStart($event)"
        @touchend="handleSwipeEnd($event)">
        <div class="w-12 h-1.5 bg-gray-600 rounded-full"></div>
      </div>

      <!-- 헤더 -->
      <div class="flex justify-between items-center px-4 pb-2 flex-shrink-0">
        <h3 class="font-semibold flex items-center gap-2 text-sm">
          <i data-lucide="message-square" class="w-4 h-4"></i> 채팅
        </h3>
        <button @click="closeMobileChat()" class="p-1 hover:bg-gray-700 rounded-lg transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- 메시지 목록 -->
      <div class="flex-1 overflow-y-auto px-4 space-y-2 min-h-0" x-ref="mobileChatContainerRef">
        <template x-for="msg in chatMessages" :key="msg.timestamp">
          <div class="text-sm">
            <span class="font-medium text-primary" x-text="msg.nickname + ':'"></span>
            <span x-text="msg.message"></span>
          </div>
        </template>
        <div x-show="chatMessages.length === 0" class="text-gray-500 text-sm text-center py-4">
          아직 메시지가 없습니다
        </div>
      </div>

      <!-- 입력 폼 -->
      <div class="p-4 flex-shrink-0 pb-safe">
        <form @submit.prevent="sendChat()" class="flex gap-2"
          x-show="room.state !== 'defense' || defenderId === playerId">
          <input
            type="text"
            x-model="chatInput"
            placeholder="메시지"
            maxlength="200"
            class="flex-1 min-w-0 px-3 py-2 bg-gray-700 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none"
          >
          <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg text-sm transition-colors">전송</button>
        </form>
        <div x-show="room.state === 'defense' && defenderId !== playerId" class="text-gray-500 text-xs text-center">
          변론자만 채팅할 수 있습니다
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/js/game.js"></script>
<script>
  window.ROOM_ID = '<%= roomId %>';
  window.INITIAL_ROOM = <%- JSON.stringify(room) %>;
  window.CATEGORIES = <%- JSON.stringify(categories) %>;
</script>
<%- include('partials/scripts') %>
</body>
</html>
