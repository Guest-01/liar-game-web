<!DOCTYPE html>
<html lang="ko">
<head>
  <%- include('partials/head') %>
</head>
<body class="bg-gray-900 text-white min-h-screen">
<div x-data="lobbyPage()" x-init="init()" class="container mx-auto px-4 py-8 max-w-6xl min-h-screen flex flex-col">
  <!-- 2단 레이아웃 -->
  <div class="lg:grid lg:grid-cols-5 lg:gap-8 flex-1">
    <!-- 왼쪽: 게임 시작 영역 -->
    <div class="lg:col-span-2 mb-8 lg:mb-0">
      <!-- 헤더 -->
      <header class="text-center lg:text-left mb-8">
        <h1 class="text-4xl font-bold mb-2 flex items-center justify-center lg:justify-start gap-3">
          <i data-lucide="drama" class="w-10 h-10 text-primary"></i>
          <span class="bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent animate-glitch">라이어 게임</span>
        </h1>
        <p class="text-gray-400">누가 라이어인지 찾아내세요!</p>
      </header>

      <!-- 에러 메시지 -->
      <div x-show="errorMessage" x-cloak class="mb-4 p-4 bg-red-900/50 border border-red-700 rounded-xl text-red-200 flex items-center gap-2">
        <i data-lucide="alert-circle" class="w-5 h-5 flex-shrink-0"></i>
        <span x-text="errorMessage"></span>
        <button @click="errorMessage = ''" class="ml-auto p-1 hover:bg-red-800 rounded">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <!-- 닉네임 카드 -->
      <div x-data="nicknameCard()" class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <div class="flex items-center gap-2">
          <i data-lucide="user" class="w-5 h-5 text-primary"></i>
          <span class="text-gray-400 text-sm">내 닉네임</span>
        </div>

        <div class="mt-3 flex items-center gap-2">
          <!-- 편집 모드 -->
          <template x-if="editing">
            <input
              type="text"
              x-model="tempNickname"
              @blur="saveNickname()"
              @keydown.enter="saveNickname()"
              @keydown.escape="cancelEdit()"
              x-ref="nicknameInput"
              maxlength="10"
              class="flex-1 px-3 py-2 bg-gray-700 border border-primary rounded-lg focus:ring-2 focus:ring-primary outline-none text-lg font-semibold"
            >
          </template>

          <!-- 표시 모드 -->
          <template x-if="!editing">
            <button
              @click="startEdit()"
              class="flex-1 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-left text-lg font-semibold transition-colors"
              title="클릭하여 수정"
            >
              <span x-text="nickname"></span>
              <i data-lucide="pencil" class="w-4 h-4 inline ml-2 text-gray-500"></i>
            </button>
          </template>

          <!-- 랜덤 생성 버튼 -->
          <button
            @click="randomize()"
            class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
            title="랜덤 닉네임 생성"
          >
            <i data-lucide="shuffle" class="w-5 h-5"></i>
          </button>
        </div>

        <!-- 유효성 검사 메시지 -->
        <p x-show="error" x-text="error" class="mt-2 text-sm text-red-400"></p>
        <p x-show="!error && editing" class="mt-2 text-sm text-gray-500">2-10자 사이로 입력하세요</p>
      </div>

      <!-- 게임 설명 (펼침/접힘) -->
      <div x-data="{ open: window.innerWidth >= 1024 }" class="mt-6 bg-gray-800/50 rounded-xl border border-gray-700/50 overflow-hidden">
        <button
          @click="open = !open; $nextTick(() => lucide.createIcons())"
          class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-700/30 transition-colors"
        >
          <h3 class="font-semibold text-gray-300 flex items-center gap-2">
            <i data-lucide="info" class="w-4 h-4"></i> 게임 방법
          </h3>
          <i x-show="!open" data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
          <i x-show="open" data-lucide="chevron-up" class="w-4 h-4 text-gray-500"></i>
        </button>
        <div x-show="open" x-collapse>
          <div class="px-4 pb-4 space-y-3">
            <ul class="text-sm text-gray-400 space-y-1.5">
              <li>• 라이어를 제외한 모든 플레이어가 같은 제시어를 받습니다</li>
              <li>• 돌아가며 제시어를 설명하고, 토론으로 라이어를 찾으세요</li>
              <li>• 라이어가 들키면 시민 승리, 정답을 맞추면 라이어 역전!</li>
            </ul>
            <div class="space-y-2 text-xs">
              <div class="flex items-center gap-2 text-gray-500">
                <i data-lucide="target" class="w-3.5 h-3.5"></i>
                <span><strong class="text-gray-400">일반</strong>: 라이어는 제시어 없이 유추해야 함</span>
              </div>
              <div class="flex items-center gap-2 text-gray-500">
                <i data-lucide="smile" class="w-3.5 h-3.5"></i>
                <span><strong class="text-gray-400">바보</strong>: 라이어도 자신이 라이어인지 모름</span>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 오른쪽: 방 목록 -->
    <section x-data="lobbyData()" x-init="init()" class="lg:col-span-3">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <i data-lucide="home" class="w-5 h-5"></i> 방 목록
        </h2>
        <div class="flex items-center gap-2">
          <a href="/create" class="px-3 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors flex items-center gap-2 text-sm font-semibold">
            <i data-lucide="plus" class="w-4 h-4"></i>
            방 만들기
          </a>
          <button @click="refresh()" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors flex items-center gap-2 text-sm">
            <i data-lucide="refresh-cw" class="w-4 h-4" :class="loading && 'animate-spin'"></i>
            새로고침
          </button>
        </div>
      </div>

      <!-- 빈 상태 -->
      <div x-show="rooms.length === 0" class="bg-gray-800/50 rounded-xl border border-gray-700/50 py-16 text-center text-gray-500">
        <i data-lucide="users" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
        <p class="font-medium">아직 열린 방이 없습니다</p>
        <p class="text-sm mt-1">첫 번째로 방을 만들어보세요!</p>
      </div>

      <!-- 방 목록 -->
      <div class="space-y-3" x-show="rooms.length > 0">
        <template x-for="room in rooms" :key="room.id">
          <div class="bg-gray-800 rounded-xl p-4 hover:bg-gray-750 transition-colors border border-gray-700">
            <div class="flex justify-between items-center gap-4">
              <div class="min-w-0 flex-1">
                <h3 class="font-semibold flex items-center gap-2 truncate">
                  <i x-show="!room.isPublic" data-lucide="lock" class="w-4 h-4 text-yellow-400 flex-shrink-0"></i>
                  <span x-text="room.name" class="truncate"></span>
                </h3>
                <div class="flex flex-wrap gap-x-3 gap-y-1 mt-1.5 text-xs text-gray-400">
                  <span class="flex items-center gap-1">
                    <i data-lucide="users" class="w-3.5 h-3.5"></i>
                    <span x-text="room.playerCount"></span>/<span x-text="room.maxPlayers"></span>
                  </span>
                  <span class="flex items-center gap-1">
                    <i :data-lucide="room.gameMode === 'normal' ? 'target' : 'smile'" class="w-3.5 h-3.5"></i>
                    <span x-text="room.gameMode === 'normal' ? '일반' : '바보'"></span>
                  </span>
                  <span class="flex items-center gap-1">
                    <i data-lucide="folder" class="w-3.5 h-3.5"></i>
                    <span x-text="room.category"></span>
                  </span>
                </div>
              </div>
              <button @click="joinRoom(room)" class="px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg font-semibold transition-colors text-sm flex-shrink-0">
                참가
              </button>
            </div>
          </div>
        </template>
      </div>

      <!-- 방 참가 모달 (비공개 방) -->
      <div x-show="joinModal.show" x-cloak class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-sm w-full mx-4" @click.outside="joinModal.show = false">
          <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            <i data-lucide="lock" class="w-5 h-5 text-yellow-400"></i>
            <span x-text="joinModal.roomName"></span>
          </h3>
          <form @submit.prevent="submitJoin()">
            <div class="mb-4">
              <label class="block text-sm text-gray-400 mb-1">닉네임</label>
              <input
                type="text"
                x-model="joinModal.nickname"
                placeholder="닉네임 (2-10자)"
                minlength="2"
                maxlength="10"
                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary outline-none"
              >
            </div>
            <div class="mb-4">
              <label class="block text-sm text-gray-400 mb-1">비밀번호</label>
              <input
                type="password"
                x-model="joinModal.password"
                x-ref="passwordInput"
                placeholder="비밀번호"
                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary outline-none"
              >
            </div>
            <div x-show="joinModal.error" class="text-red-400 text-sm mb-4" x-text="joinModal.error"></div>
            <div class="flex gap-2">
              <button type="button" @click="joinModal.show = false" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold">취소</button>
              <button type="submit" :disabled="joinModal.loading" class="flex-1 py-3 bg-primary hover:bg-primary/80 rounded-lg font-semibold disabled:opacity-50">
                <span x-show="!joinModal.loading">참가</span>
                <span x-show="joinModal.loading">확인 중...</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>
  </div>

  <!-- 푸터 -->
  <footer class="flex items-center mt-4 pt-2 border-t border-gray-800 text-xs text-gray-500">
    <span class="flex-1">© 2025 Guest-01</span>
    <span class="flex-1 text-center">v<%= version %></span>
    <a href="https://github.com/Guest-01/liar-game-web" target="_blank" rel="noopener" class="flex-1 flex items-center justify-end gap-1 hover:text-gray-300 transition-colors">
      <i data-lucide="github" class="w-4 h-4"></i>
      GitHub
    </a>
  </footer>
</div>

<script>
function lobbyPage() {
  return {
    errorMessage: '',

    init() {
      // URL에서 에러 파라미터 확인
      const params = new URLSearchParams(window.location.search);
      const error = params.get('error');
      if (error === 'room-not-found') {
        this.errorMessage = '방을 찾을 수 없습니다.';
        // URL에서 에러 파라미터 제거
        window.history.replaceState({}, '', '/');
      }
    }
  }
}

function nicknameCard() {
  return {
    nickname: localStorage.getItem('nickname') || (typeof generateRandomNickname === 'function' ? generateRandomNickname() : ''),
    tempNickname: '',
    editing: false,
    error: '',

    init() {
      if (!this.nickname) {
        this.nickname = generateRandomNickname();
        localStorage.setItem('nickname', this.nickname);
      }
    },

    startEdit() {
      this.tempNickname = this.nickname;
      this.editing = true;
      this.error = '';
      this.$nextTick(() => {
        this.$refs.nicknameInput?.focus();
        this.$refs.nicknameInput?.select();
      });
    },

    saveNickname() {
      const trimmed = this.tempNickname.trim();

      if (trimmed.length < 2) {
        this.error = '닉네임은 2자 이상이어야 합니다.';
        return;
      }
      if (trimmed.length > 10) {
        this.error = '닉네임은 10자 이하여야 합니다.';
        return;
      }

      this.nickname = trimmed;
      localStorage.setItem('nickname', trimmed);
      this.editing = false;
      this.error = '';
    },

    cancelEdit() {
      this.editing = false;
      this.error = '';
    },

    randomize() {
      this.nickname = generateRandomNickname();
      localStorage.setItem('nickname', this.nickname);
      this.editing = false;
      this.error = '';
    }
  }
}

function lobbyData() {
  return {
    rooms: <%- JSON.stringify(lobbyRooms) %>,
    loading: false,
    socket: null,
    joinModal: {
      show: false,
      roomId: null,
      roomName: '',
      nickname: localStorage.getItem('nickname') || '',
      password: '',
      error: '',
      loading: false
    },

    init() {
      // 초기 렌더링 후 Lucide 아이콘 생성
      this.$nextTick(() => lucide.createIcons());

      // 주기적으로 새로고침
      setInterval(() => this.refresh(), 10000);

      // 소켓 연결 (검증용)
      this.socket = io();
      this.socket.on('verify-join-result', (data) => {
        this.joinModal.loading = false;
        if (data.success) {
          // 검증 성공: 페이지 이동
          localStorage.setItem('nickname', this.joinModal.nickname);
          const url = '/room/' + this.joinModal.roomId +
            '?nickname=' + encodeURIComponent(this.joinModal.nickname) +
            '&password=' + encodeURIComponent(this.joinModal.password);
          window.location.href = url;
        } else {
          // 검증 실패: 에러 표시
          this.joinModal.error = data.message;
        }
      });
    },

    async refresh() {
      this.loading = true;
      try {
        const res = await fetch('/api/rooms');
        const data = await res.json();
        this.rooms = data.rooms;
        this.$nextTick(() => lucide.createIcons());
      } catch (e) {
        // 방 목록 로딩 실패 시 무시 (10초마다 재시도함)
      }
      this.loading = false;
    },

    joinRoom(room) {
      const nickname = localStorage.getItem('nickname') || '';
      if (room.isPublic) {
        // 공개 방: 바로 이동
        window.location.href = '/room/' + room.id + '?nickname=' + encodeURIComponent(nickname);
      } else {
        // 비공개 방: 모달 표시
        this.joinModal = {
          show: true,
          roomId: room.id,
          roomName: room.name,
          nickname: nickname,
          password: '',
          error: '',
          loading: false
        };
        this.$nextTick(() => {
          this.$refs.passwordInput?.focus();
          lucide.createIcons();
        });
      }
    },

    submitJoin() {
      // 클라이언트 기본 검증
      if (!this.joinModal.nickname || this.joinModal.nickname.length < 2) {
        this.joinModal.error = '닉네임은 2자 이상이어야 합니다.';
        return;
      }
      if (this.joinModal.nickname.length > 10) {
        this.joinModal.error = '닉네임은 10자 이하여야 합니다.';
        return;
      }
      if (!this.joinModal.password) {
        this.joinModal.error = '비밀번호를 입력하세요.';
        return;
      }

      // 서버에 검증 요청
      this.joinModal.loading = true;
      this.joinModal.error = '';
      this.socket.emit('verify-join', {
        roomId: this.joinModal.roomId,
        nickname: this.joinModal.nickname,
        password: this.joinModal.password
      });
    }
  }
}
</script>
<%- include('partials/scripts') %>
</body>
</html>
